parameters:
  seriviceConnectionName: ""
  systemName: "demodeploy"
  environmentName: "prod"
  artifactName: "bicep-templates"
  location: ""
  locationAbbriviation: ""

jobs:
  - job: publishbicep
    displayName: Publish bicep files as pipeline artifacts
    pool:
      vmImage: "ubuntu-latest"

    steps:
      - task: DownloadPipelineArtifact@0
        displayName: "Download Artifact: ${{ parameters.artifactName }}"
        inputs:
          artifactName: "${{ parameters.artifactName }}"
          targetPath: $(System.ArtifactsDirectory)/${{ parameters.artifactName }}

      - task: AzureCLI@2
        displayName: Azure CLI - Create resource group ${{parameters.systemName}}-${{parameters.environmentName}}-${{parameters.locationAbbriviation}}
        inputs:
          azureSubscription: ${{ parameters.seriviceConnectionName }}
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            az group create -l "${{parameters.location}}" -n "${{parameters.systemName}}-${{parameters.environmentName}}-${{parameters.locationAbbriviation}}"

      - task: AzureCLI@2
        displayName: Azure CLI - Deploy Bicep
        inputs:
          azureSubscription: ${{ parameters.seriviceConnectionName }}
          scriptType: pscore
          scriptLocation: inlineScript
          inlineScript: |
            az deployment group create `
            --template-file "$(System.ArtifactsDirectory)/${{ parameters.artifactName }}/main.bicep" `
            --resource-group "${{parameters.systemName}}-${{parameters.environmentName}}-${{parameters.locationAbbriviation}}" `
            --parameters locationAbbriviation=${{parameters.locationAbbriviation}}
