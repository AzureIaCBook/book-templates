parameters:
  seriviceConnectionName: ""
  environmentName: "test"
  artifactName: "arm-templates"
  location: ""
  locationAbbriviation: ""

steps:
  - task: DownloadPipelineArtifact@0
    displayName: "Download Artifact: ${{ parameters.artifactName }}"
    inputs:
      artifactName: "${{ parameters.artifactName }}"
      targetPath: $(System.ArtifactsDirectory)/${{ parameters.artifactName }}

  - task: AzureResourceManagerTemplateDeployment@3
    displayName: Deploy Main Template
    inputs:
      azureResourceManagerConnection: "${{ parameters.seriviceConnectionName }}"
      deploymentScope: "Subscription"
      subscriptionId: "${{ parameters.subscriptionId }}"
      location: ${{ parameters.location }}
      templateLocation: "Linked artifact"
      csmFile: "$(System.ArtifactsDirectory)/${{ parameters.artifactName }}/main.json"
      csmParametersFile: "$(System.ArtifactsDirectory)/${{ parameters.artifactName }}/${{parameters.environmentName}}.parameters.json"
      overrideParameters: -locationAbbriviation ${{parameters.locationAbbriviation}}
      deploymentMode: "Incremental"
